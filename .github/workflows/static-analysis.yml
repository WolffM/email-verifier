name: Static Analysis (Stage 4b)
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or SHA to analyze'
        required: true

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  ruff:
    name: ruff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install ruff
      - name: Auto-fix
        run: ruff check . --fix || true
      - name: Commit fixes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          git diff --cached --quiet || git commit -m 'style: auto-fix ruff findings'
          git push || true
      - run: ruff check . --output-format=github
  pytest:
    name: pytest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install -r requirements.txt 2>/dev/null || true
      - run: pip install pytest 2>/dev/null || true
      - run: python -m pytest -v || true
